# Tray Service

## 托盘 logo
```ts
// main/utils/index.ts

// 获取logo
let logo: string | void = void 0;
export function createLogo() {
  if (logo != null) {
    return logo;
  }
  // vite.render.config.ts 配置了打包根目录 publicDir: 'public'
  // path 直接从打包后的路径中获取
  logo = path.join(__dirname, 'logo.ico');
  return logo;
}
```

## 托盘服务
编写托盘实例方法，创建托盘菜单等。
```ts
// main/service/TrayService.ts

import { Tray, Menu, ipcMain, app } from 'electron';
import { createTranslator, createLogo } from '../utils';
import { CONFIG_KEYS, IPC_EVENTS, WINDOW_NAMES, MAIN_WIN_SIZE } from '../../common/constants';

import logManager from './LogService';
// TODO: shortcutManager
import windowManager from './WindowService';
import configManager from './ConfigService';

let t: ReturnType<typeof createTranslator> = createTranslator();

class TrayService {
  private static _instance: TrayService;
  private _tray: Tray | null = null;
  private _removeLanguageListener?: () => void;

  private _setupLanguageChangeListener() {
    // 监听语言变化
    this._removeLanguageListener = configManager.onConfigChange((config) => {
      if (!config[CONFIG_KEYS.LANGUAGE]) return;

      // 切换语言后，重新创建翻译器
      t = createTranslator();


      if (this._tray) {
        this._updateTray();
      }
    })
  }

//   创建 更新 托盘
  private _updateTray() {
    if (!this._tray) {
      this._tray = new Tray(createLogo());
    }

    // 显示窗口
    const showWindow = () => {
      const mainWindow = windowManager.get(WINDOW_NAMES.MAIN);

    //   若窗口正在显示，且不被focus时，仅focus即可
      if (mainWindow && !mainWindow?.isDestroyed() && mainWindow?.isVisible() && !mainWindow?.isFocused()) {
        return mainWindow.focus();
      }
      if (mainWindow?.isMinimized()) {
        return mainWindow?.restore();
      }

    //   若窗口正在显示，且focus，不做操作（找茬呢）
      if (mainWindow?.isVisible() && mainWindow?.isFocused()) return;

      windowManager.create(WINDOW_NAMES.MAIN, MAIN_WIN_SIZE);
    }

    this._tray.setToolTip(t('tray.tooltip') ?? 'Cecilia Application');

    // TODO: 依赖快捷键Service 

    // 托盘菜单
    this._tray.setContextMenu(Menu.buildFromTemplate([
      { label: t('tray.showWindow'), accelerator: 'CmdOrCtrl+N', click: showWindow },
      { type: 'separator' },
      { label: t('settings.title'), click: () => ipcMain.emit(`${IPC_EVENTS.OPEN_WINDOW}:${WINDOW_NAMES.SETTING}`) },
      { role: 'quit', label: t('tray.exit') }
    ]));

    // 取消所有click监听，再重新绑定
    // _updateTray可能会被多次调用（切换语言时），因此需要重新绑定监听
    this._tray.removeAllListeners('click');
    this._tray.on('click', showWindow);
  }

  private constructor() {
    this._setupLanguageChangeListener();
    logManager.info('TrayService initialized successfully.');
  }

  public static getInstance() {
    if (!this._instance) {
      this._instance = new TrayService();
    }
    return this._instance;
  }

//   初始化create
  public create() {
    if (this._tray) return;
    this._updateTray();
    app.on('quit', () => {
      this.destroy();
      //TODO: 移除快捷键
    })
  }
  
  public destroy() {
    this._tray?.destroy();
    this._tray = null;
    //TODO: 移除快捷键
    if (this._removeLanguageListener) {
      this._removeLanguageListener();
      this._removeLanguageListener = void 0;
    }
  }
}

export const trayManager = TrayService.getInstance();
export default trayManager;

```


## 托盘注册
在主窗口的 index 中，注册托盘服务
```ts
// main/wins/main.ts

// 托盘操作，创建 销毁
const handleTray = (minimizeToTray: boolean) => {
  if (minimizeToTray) {
    trayManager.create();
    return;
  }
  trayManager.destroy();
}


// setupMainWindow()
windowManager.onWindowCreate(WINDOW_NAMES.MAIN, (mainWindow: any) => {
    let minimizeToTray = configManager.get(CONFIG_KEYS.MINIMIZE_TO_TRAY)

    // config change
    configManager.onConfigChange((config) => {
      if(minimizeToTray === config[CONFIG_KEYS.MINIMIZE_TO_TRAY]) return;
      minimizeToTray = config[CONFIG_KEYS.MINIMIZE_TO_TRAY];  // 更新
      // 配置变化，切换最小化状态（开启or关闭）
      handleTray(minimizeToTray)  // 配置变化时再次调用
    })

    // 获取托盘状态，并初始化（开启or关闭）
    handleTray(minimizeToTray)
    registerMenus(mainWindow);
  });

```