# 对话列表


## 注册 vue-router、pinia、功能栏、拖拽区域
从此不需要特地 import 标题栏和拖拽区域：
```ts
// renderer/index.ts

import { type Plugin } from 'vue';
import { createMemoryHistory, createRouter } from 'vue-router';
import { createPinia } from 'pinia';

import TitleBar from './components/TitleBar.vue';
import DragRegion from './components/DragRegion.vue';


// 直接注册到vue实例上，不需要在script语块引入这俩组件
const components: Plugin = function (app: any) {
  app.component('TitleBar', TitleBar);
  app.component('DragRegion', DragRegion);
}

// 注册vue-router
const router = createRouter({
    history: createMemoryHistory(),
    routes: [
        {
            path: '/',
            component: () => import ('./views/Index.vue')
        }
    ]
})

// 注册pinia
const pinia = createPinia();


createApp(App).use(pinia).use(router).use(components)...
```
随便写了一个 main 区域组件：
```vue
<template>
  <div class="main-view h-full w-full flex flex-col">
    <title-bar>
      <drag-region class="w-full" />
    </title-bar>
    <main class="flex-auto">
      <!-- <router-view /> -->
       main
    </main>
  </div>
</template>
```


## 对话栏
由 `SearchBar` 和 `ListItem` 组成。

### 搜索栏
`@contextmenu.stop @click.stop` 创建一个 “静默” 区域，点击不会触发任何父级元素的相关事件，右键不会弹出浏览器菜单（为自定义菜单做准备）。
```vue
<!-- components/ConversationList/SearchBar.vue -->

<script setup lang="ts">
import { NInput, NInputGroup, NInputGroupLabel, NIcon } from 'naive-ui';
import { Icon as IconifyIcon } from '@iconify/vue';
import { useFilter } from './useFilter';
defineOptions({ name: 'SearchBar' });

const { searchKey } = useFilter();
const { t } = useI18n();
</script>

<template>
  <div class="my-2" @contextmenu.stop @click.stop>
    <n-input-group>
      <n-input v-model:value="searchKey" size="small" :placeholder="t('main.conversation.searchPlaceholder')" clearable>
        <template #prefix>
          <iconify-icon icon="material-symbols:search" />
        </template>
      </n-input>
      <n-input-group-label class="cursor-pointer flex justify-between items-center">
        <n-icon>
          <iconify-icon icon="material-symbols:menu" />
        </n-icon>
      </n-input-group-label>
    </n-input-group>
  </div>
</template>

<style scoped>
.n-input-wrapper,
.n-input__input {
  align-items: center;
}

.n-input-group-label,
.n-input__input {
  display: flex;
}

:deep(.n-input__input-el) {
  translate: 0 3px !important;
}
</style>
```

### 对话列表
事先定义好 emit，为以后右键鼠标，修改对话标题做准备。
```vue
<!-- components/ConversationList/ListItem.vue -->

<script setup lang="ts">
import type { Conversation } from '../../../common/types'
import { Icon as IconifyIcon } from '@iconify/vue'

const _PIN_ICON_SIZE = 16 as const

defineOptions({ name: 'ConversationListItem' });

// 接收外面传进来的对话属性，例如title、selectedModel
defineProps<Conversation>();
// 向父组件传递新title，可以重命名对话标题
const emit = defineEmits(['updateTitle']);
</script>

<template>
  <div class="conversation-desc text-tx-secondary flex justify-between items-center text-sm loading-5">
    <span>
      {{ selectedModel }}
      <iconify-icon class="inline-block" v-if="pinned" icon="material-symbols:keep-rounded" :width="_PIN_ICON_SIZE"
        :height="_PIN_ICON_SIZE" />
    </span>
  </div>
  <div class="w-full flex items-center">
    <!-- 复选框 预留 -->
    <div class="flex-auto">
      <h2 class="conversation-title w-full text-tx-secondary font-semibold loading-5 truncate">
        {{ title }}
      </h2>
    </div>
  </div>
</template>
```
然后在 `Index.vue` 中使用这俩：
```vue
<!-- ConversationList/Index -->
<template>
  <div >
    <search-bar />
    <ul>
      <template v-for="item in conversations" :key="item.id">
        <li v-if="item.type !== 'divider'">
          <list-item v-bind="item" />
        </li>

        <!-- 分割线 -->
        <li v-else class="divider"></li>
      </template>
    </ul>
  </div>
</template>
```
将 Index.vue 作为 conversationList 组件引用到 App 中：
```vue
<!-- App.vue -->
<template>
  <n-config-provider>
    <aside>
      <div>
        <!-- 功能栏 -->
        <nav-bar />
        <!-- 对话栏 -->
        <conversation-list />
      </div>
    </aside>
    <resize-divider />

    <!-- main -->
    <div>
      <router-view />
    </div>
  </n-config-provider>
</template>
```


## 对话信息存储与筛选

### pinia 存储对话信息
`allConversations` 方法只提供最新的对话列表读取。
```ts
// renderer/stores/conversations.ts

import type { Conversation } from '../../common/types';
import { conversations as testConversations } from '../testData';

export const useConversationsStore = defineStore('conversations', () => {
  const conversations = ref<Conversation[]>(testConversations);


//   computed只读，这是getter方法，只读取对话最新内容
  const allConversations = computed(() => conversations.value)
  return {
    conversations,
    allConversations,
  }
})
```


### useFilter 筛选对话列表
通过 `searchKey` 筛选 stores 里的对话列表，即可用于 Index.vue 中：
```ts
// ConversationList/useFilter.ts

import { useConversationsStore } from '../../stores/conversations';

const searchKey = ref('');

// 对话筛选器
export function useFilter() {
  const conversationsStore = useConversationsStore();

  const filteredConversations = computed(() => {

    return conversationsStore.allConversations
  })

  return {
    searchKey,
    conversations: filteredConversations
  }
}
```


### 类型补充
```ts
// common/types.ts
export interface Conversation {
  id: number;
  title: string;
  selectedModel: string;
  createdAt: number;
  updatedAt: number;
  providerId: number;
  pinned: boolean;
  type?: 'divider' | 'conversation';
}

export type MessageStatus = 'loading' | 'streaming' | 'success' | 'error';
export interface Message {
  id: number;
  content: string;
  type: 'question' | 'answer';
  createdAt: number;
  updatedAt?: number;
  status?: MessageStatus
  conversationId: number;
}
```

## 假数据 testData
暂时写死对话信息
```ts
import { Message, Conversation } from '../common/types'

/**
 * 生成随机日期时间戳
 * @param start 开始日期
 * @param end 结束日期
 * @returns 时间戳数字
 */
const randomDate = (start: Date, end: Date): number => {
  return start.getTime() + Math.random() * (end.getTime() - start.getTime());
};

// 定义测试数据的日期范围
const startDate = new Date(2024, 0, 1); // 2024年1月1日
const endDate = new Date(2024, 11, 31); // 2024年12月31日

export const messages: Message[] = [
  // 会话1
  { id: 1, content: '什么是光合作用？能简单介绍一下吗？', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'question', conversationId: 1 },
  { id: 2, content: '光合作用是绿色植物、藻类和某些细菌利用叶绿素吸收光能，将二氧化碳和水转化为有机物并释放氧气的过程。这是地球上几乎所有生命能量的来源。', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', conversationId: 1 },
  { id: 3, content: '光合作用的具体过程是怎样的？有哪些关键步骤？', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'question', conversationId: 1 },
  { id: 4, content: '光合作用分为光反应和暗反应两个阶段。光反应发生在类囊体膜上，通过光解水产生氧气、ATP和NADPH；暗反应（卡尔文循环）发生在叶绿体基质中，利用这些能量将二氧化碳固定成有机物。', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', conversationId: 1 },
  { id: 5, content: '哪些因素会影响光合作用的效率？', createdAt: randomDate(startDate, endDate), type: 'question', updatedAt: randomDate(startDate, endDate), conversationId: 1 },
  { id: 6, content: '', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', status: 'loading', conversationId: 1 },

  // 会话2
  { id: 7, content: '人工智能目前的发展趋势是什么？', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'question', conversationId: 2 },
  { id: 8, content: '当前AI发展呈现出大模型、多模态融合、低代码化、专用化等趋势。大语言模型如GPT、Claude等能力持续提升，同时AI在医疗、金融、教育等垂直领域的应用也日益深入。', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', conversationId: 2 },
  { id: 9, content: 'AI技术在医疗领域有哪些具体应用？', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'question', conversationId: 2 },
  { id: 10, content: 'AI在医疗领域的应用非常广泛，包括医学影像诊断、药物研发、智能病历管理、个性化治疗方案制定等。例如，深度学习算法已能在某些癌症筛查中达到甚至超过专业医生的水平。', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', conversationId: 2 },

  // 会话3
  { id: 11, content: '量子计算和传统计算有什么本质区别？', createdAt: randomDate(startDate, endDate), type: 'question', updatedAt: randomDate(startDate, endDate), conversationId: 3 },
  { id: 12, content: '', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), type: 'answer', status: 'loading', conversationId: 3 },
];

export const conversations: Conversation[] = [
  { id: 1, selectedModel: 'ERNIE-4.0-8K', title: '光合作用基本原理详解', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), providerId: 1, pinned: true },
  { id: 2, selectedModel: 'qwen-plus', title: '人工智能发展趋势与应用', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), providerId: 2, pinned: false },
  { id: 3, selectedModel: 'deepseek-chat', title: '量子计算基础概念解析', createdAt: randomDate(startDate, endDate), updatedAt: randomDate(startDate, endDate), providerId: 3, pinned: false },
];
```
