# 对话标题溢出处理

## 依赖注入
`ctx` 充当数据管道，可以直接劫取最外层祖先组件的 `width`：
```ts
import type { InjectionKey, ComputedRef } from 'vue';

export const CTX_KEY: InjectionKey<{
  width: ComputedRef<number>;
}> = Symbol('ConversationListContext');
```

## 重构一个对话标题栏组件 `ItemTitle`
组件挂载时直接检查 title 是否溢出，是则截断，且鼠标悬停显示完整 title；否则直接显示完整 title。  
也会时刻监听对话栏宽度变化：
```vue
<script setup lang="ts">
import { CTX_KEY } from './constants';

import NativeTooltip from '../NativeTooltip.vue';

interface ItemTitleProps {
  title: string;
}

defineOptions({ name: 'ItemTitle' });

// 组件外部将title传回来
const props = defineProps<ItemTitleProps>();

const ctx = inject(CTX_KEY, void 0);

const isTitleOverflow = ref(false);
const titleRef = useTemplateRef<HTMLElement>('titleRef');


function checkOverflow(element: HTMLElement | null): boolean {
  if (!element) return false;
  return element.scrollWidth > element.clientWidth;
}

// 将标题溢出为true赋值给isTitleOverflow
function _updateOverflowStatus() {
  isTitleOverflow.value = checkOverflow(titleRef.value);
}

// vueuse的防抖方法
const updateOverflowStatus = useDebounceFn(_updateOverflowStatus, 100);


// 触发时机
onMounted(() => {
    // 初始检查：一开始是否溢出
  updateOverflowStatus();
    // 挂载检查：一有尺寸变化则执行update
  window.addEventListener('resize', updateOverflowStatus);
})

onUnmounted(() => {
  window.removeEventListener('resize', updateOverflowStatus);
})

// 监听变化
watch([() => props.title, () => ctx?.width.value], () => updateOverflowStatus());
</script>

<template>
  <h2 ref="titleRef" class="conversation-title w-full text-tx-secondary font-semibold loading-5 truncate">
    <template v-if="isTitleOverflow">
      <native-tooltip :content="title">
        {{ title }}
      </native-tooltip>
    </template>
    <template v-else>
      {{ title }}
    </template>
  </h2>
</template>
```


## 通信链路

### App.vue 传递 siderBarWidth
将 siderBarWidth 传给 conversationList，  
将接收到的宽度包装成一个计算属性，然后通过 `provide` 方法，将其放入一个由 `CTX_KEY` 标识的 “秘密信箱” 中。
```ts
// conversationList/Index.vue

const props = defineProps<{width: number}>();

provide(CTX_KEY, { width: computed(() => props.width) });
```


### ItemTitle 使用 siderBarWidth
```ts
const ctx = inject(CTX_KEY, void 0);
```
用这行代码，劫取祖先组件的 ctx，并取出 width。  
祖先组件对话栏宽度变化时，ctx.width 也会变化，ItemTitle 组件会自动更新。

### ListItem 修改
将标题的插值表达式替换成 item-title：
```vue
<template>
  <div>
    <span>
      {{ selectedModel }}
      <iconify-icon />
    </span>
  </div>
  <div >
    <!-- 复选框 预留位置 -->
    <!-- <div class="flex-auto"> -->
      <item-title :title="title" />
    <!-- </div> -->
  </div>
</template>
```