# 各种优化

## 目录扁平化
按照进程和功能扁平化分区
```bash
# 目录结构
.
├── common # 公共模块
├── html # 页面入口
├── locales # 国际化
├── main # 主进程
│   ├── index.ts
├── renderer # 渲染进程
│   ├── index.ts
│   ├── App.vue
├── preload.ts # 预加载脚本
```


## 日志、配置本地存储
目的都是为了方便管理，且配置本地持久化：
 - 日志地址：C:/users/86134/AppData/Roaming/{AppName}/logs
 - 配置地址：C:/Users/86134/AppData/Roaming/{AppName}/config.json


## 手搓方法
除了章节一，还有一些自己封装的防抖、节流、深度合并、深浅拷贝、openSetting 加解密、去重方法等，都是针对本项目的方法封装。在 `common/utils` 中；


## 数据复用
每一处地方的数据都会设置一个数据结构进行存储旧数据，方便复用，比如 message、config 等

## 数据污染
在每个方法中都会定义一个变量来拷贝源数据或者方法，防止意外bug，同时在方法的最后也会通过 `void 0` 来回收内存，避免泄露。

## 多对话串流
 - streaming 过程中，存储流式拼接结果 `Map[msgId, msgContent + streamData]`，防止不同 msg 串流，拼错了；最后也会删除该 map 释放内存。
 - 此处同样也会用 Map 存储不同对话的 `stop()`，用于停止不同 msg 的流式拼接，最后也会 void 0 回收内存。
```ts
// 拼接流式内容
  msgContentMap.set(messageId, msgContentMap.get(messageId) + data.result)

// 存放不同对话的stop方法，用于停止监听
  stopMethods.set(loadingMsgId, listenDialogueBack(streamCallback, loadingMsgId))
```

## logo 鲁棒性
在设置托盘 logo 时发现为空，于是用 `nativeImage.createFromPath()` 来隔绝污染其他功能，增强鲁棒性

## 响应式 config
在钩子 useConfig 中，设置响应式 config，实现 setting 和 main 窗口双向联动。


## 快捷键双层防护
在设置快捷键的关闭和打开窗口时，为了避免关闭后再次打开时，功能丢失，我们做了两层防护：
 - 在设置快捷键时，屏蔽浏览器默认的快捷键行为；（windowService）
 - 在初始化 main 窗口时，为了避免意外退出（结束进程...），我们在窗口创建时，重新初始化所有功能；（main/wins/main）
以上防护，一个是可预知的关闭行为的接管代理，在我们的可控范围内退出；一个就是不可预知的情况的防护。

## 图标预加载
使用 `promise.all(loadIcon())` 预加载所有图标，避免闪烁。

## 打包
在40章中有体现，比如打包后的logo、用户篡改源码、体验优化等

## 图片显示
为了省略加载过程，优化体验，将图片通过 base64 编码，然后用 img 的 src 引入；